# 1. ì›¹ì†Œì¼“

- [RFC 6455](https://datatracker.ietf.org/doc/html/rfc6455)ì— ì •ì˜ ëœ í”„ë¡œí† ì½œ
- ì„œë²„ì™€ ë¸Œë¼ìš°ì €ê°„ ì—°ê²°ì„ ìœ ì§€í•œ ìƒíƒœë¡œ ë°ì´í„° êµí™˜ ê°€ëŠ¥

  > ë°ì´í„°ëŠ” íŒ¨í‚· í˜•íƒœë¡œ ì „ë‹¬ë˜ë©° ì „ì†¡ì€ ì–‘ë°©í–¥ìœ¼ë¡œ ì´ë£¨ì–´ì§

- `ws`ë¼ëŠ” íŠ¹ìˆ˜ í”„ë¡œí† ì½œ ì‚¬ìš©

```
// npm install ws
let socket = new WebSocket("wss://homepage.com");
```

- `ws://`ì™€ `wss://`ì˜ ì°¨ì´ :
  - `ws`ëŠ” ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•˜ì§€ ì•Šì€ì±„ë¡œ ì „ì†¡
  - `wss`ëŠ” TLS ê³„ì¸µì„ í†µê³¼í•˜ì—¬ ì „ì†¡ë˜ë¯€ë¡œ ë°ì´í„° ì•”ë³µí˜¸í™”ê°€ ì´ë£¨ì–´ì§

## 1-1 ì›¹ì†Œì¼“ ì´ë²¤íŠ¸

```
let socket = new WebSocket(url);

// open : ì»¤ë„¥ì…˜ì´ ì—°ê²°ë˜ì—ˆì„ë•Œ ë°œìƒ
socket.onopen = function (e) {
	// send : ë°ì´í„° ì „ì†¡
	socket.send("Hello!");
}

// message : ë°ì´í„° ìˆ˜ì‹ ì‹œ ë°œìƒ
socket.onmessage = function(e) {
	alert(`ë°ì´í„° : ${e.data}`);
}

// close : ì»¤ë„¥ì…˜ ì¢…ë£Œì‹œ ë°œìƒ
socket.onclose = function(e) {
	// ì •ìƒì ì¸ ê²½ìš°
	if (event.wasClean) { alert(`ì •ìƒ ì¢…ë£Œ, code=${e.code} reason=${e.reason}`) }
	// í”„ë¡œì„¸ìŠ¤ ì£½ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ì¥ì• ì‹œ code = 1006
	else { alert(`ì»¤ë„¥ì…˜ì´ ì£½ì—ˆìŠµë‹ˆë‹¤`) }
}

// error : ì—ëŸ¬ ë°œìƒì‹œ
socket.onerror = function(e){
	alert(e);
}
```

## 1-2 ì›¹ì†Œì¼“ í•¸ë“œì„¸ì´í¬

- `new WebSocket()`ì„ í˜¸ì¶œí•˜ì—¬ ì†Œì¼“ ìƒì„±ì‹œ ì¦‰ì‹œ ì—°ê²° ì‹œì‘

  > ì»¤ë„¥ì…˜ ìœ ì§€ë˜ëŠ” ë™ì•ˆ ë¸Œë¼ìš°ì €ëŠ” í—¤ë”ë¥¼ í†µí•´ ì„œë²„ì— ì›¹ì†Œì¼“ ì§€ì›í•˜ëŠ”ì§€ ë¬¼ì–´ë´„

  > ì„œë²„ê°€ OK ì‘ë‹µì„ í•˜ë©´ ì„œë²„-ë¸Œë¼ìš°ì €ê°„ í†µì‹ ì€ HTTPê°€ ì•„ë‹Œ ì›¹ì†Œì¼“ì„ í†µí•´ ì§„í–‰

- ì›¹ì†Œì¼“ì€ ê¸°ë³¸ì ìœ¼ë¡œ CORS ìš”ì²­ì„ ì§€ì›
- ì˜¤ë˜ëœ ì„œë²„ëŠ” ì›¹ì†Œì¼“ í†µì‹  ì§€ì›í•˜ì§€ ì•ŠìŒ -> í˜¸í™˜ì„± ë¬¸ì œ X

### ë¸Œë¼ìš°ì €ì¸¡ ì›¹ì†Œì¼“ ìš”ì²­ í—¤ë”

```
GET /chat
Host : homepage.com
Origin : https://homepage.com
// í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ í”„ë¡œí† ì½œ ë³€ê²½ ìš”ì²­
Connection : Upgrade
// ë³€ê²½ ìš”ì²­í•œ í”„ë¡œí† ì½œì´ websocket
Upgrade : websocket
// ì„œë²„ê°€ ì›¹ì†Œì¼“ í”„ë¡œí† ì½œ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸
Sec-WebSocket-Key : Iv8io/92...
// ì›¹ì†Œì¼“ í”„ë¡œí† ì½œ ë²„ì „
Sec-WebSocket-Version : 13
// ì›¹ì†Œì¼“ í”„ë¡œí† ì½œ ê¸°ëŠ¥ í™•ì¥
Sec-WebSocket-Extensions
// ì„œë¸Œí”„ë¡œí† ì½œ ì‚¬ìš©
Sec-WebSocket-Protocol
```

- XMLHttpRequest , fetchë¡œ ìœ ì‚¬í•œ í—¤ë”ë¥¼ ê°€ì§„ HTTP ìš”ì²­ ìƒì„± ë¶ˆê°€

- `new WebSocket()`ì˜ ë‘ ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ì— Extension, Protocol ì„¤ì • ê°€ëŠ¥

  - Extensions :

    - `deflate-frame` : ë¸Œë¼ìš°ì €ì—ì„œ ë°ì´í„° ì••ì¶• ì§€ì›

  - Protocol :

    - `soap, wamp` : SOAP, WAMP í”„ë¡œí† ì½œì„ ì¤€ìˆ˜í•˜ëŠ” ë°ì´í„° ì „ì†¡
    - [ì„œë¸Œí”„ë¡œí† ì½œ ëª©ë¡](https://www.iana.org/assignments/websocket/websocket.xml)

```
let socket = new WebSocket("wss://...", ["soap","wamp"])
```

### ì„œë²„ì¸¡ ì›¹ì†Œì¼“ ë™ì˜ ì‘ë‹µ í—¤ë”(ìƒíƒœì½”ë“œ 101)

```
101 Switching Protocols
Upgrade : websocket
Connection : Upgrade
// ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ ë§Œë“  Sec-WebSocket-Key
Sec-WebSocket-Accept : hsBlsjul....
Sec-WebSocket-Extensions : defalte-frame
Sec-WebSocket-Protocol : soap
```

## 1-3 ë°ì´í„° ì „ì†¡

- ì›¹ì†Œì¼“ í†µì‹ ì€ í”„ë ˆì„(frame)ì´ë¼ ë¶ˆë¦¬ëŠ” ë°ì´í„° ì¡°ê°ì„ ì‚¬ìš©í•´ ì´ë£¨ì–´ì§

  - í”„ë ˆì„ ì¢…ë¥˜
    - í…ìŠ¤íŠ¸ í”„ë ˆì„
    - ì´ì§„ ë°ì´í„° í”„ë ˆì„
    - í•‘í í”„ë ˆì„ : ì»¤ë„¥ì…˜ì´ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í”„ë ˆì„(ìë™ ìƒì„±)
    - ì»¤ë„¥ì…˜ ì¢…ë£Œ í”„ë ˆì„ ë“±

- ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œ ê°œë°œìëŠ” í…ìŠ¤íŠ¸ë‚˜ ì´ì§„ ë°ì´í„° í”„ë ˆì„ë§Œ ë‹¤ë£¸

  > WebSocketì˜ `send()` ë©”ì„œë“œëŠ” í…ìŠ¤íŠ¸ë‚˜ ì´ì§„ ë°ì´í„°ë§Œ ë³´ë‚¼ ìˆ˜ ìˆê¸° ë•Œë¬¸

- ë°ì´í„°ë¥¼ ë°›ì„ ë•Œ í…ìŠ¤íŠ¸ëŠ” í•­ìƒ ë¬¸ìì—´ í˜•íƒœ

  > ì´ì§„ë°ì´í„°ì˜ ê²½ìš° Blob ë˜ëŠ” ArrayBuffer ì¤‘ í•˜ë‚˜ ì„ íƒ ê°€ëŠ¥

  > `socket.binaryType` í”„ë¡œí¼í‹°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ íƒ(ê¸°ë³¸ ê°’ Blob)

  > Blobì€ `<a>, <img>` íƒœê·¸ì™€ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥

  > ê°œë³„ ë°ì´í„° ë°”ì´íŠ¸ì— ì ‘ê·¼í•´ì•¼í•  ê²½ìš° ArrayBufferë¡œ ì‚¬ìš©

```
socket.binaryType = "arraybuffer";
socket.onmessage = (e) => {
	...
}
```

## 1-4 ì „ì†¡ ì œí•œ

- ë¸Œë¼ìš°ì €ì—ì„œ `send()` ë©”ì„œë“œë¥¼ ê³„ì† í˜¸ì¶œ í•  ìˆ˜ëŠ” ìˆìŒ

  > í•˜ì§€ë§Œ ë°ì´í„°ê°€ ë²„í¼ ë©”ëª¨ë¦¬ì— ìŒ“ì´ë©´ì„œ ë„¤íŠ¸ì›Œí¬ ì†ë„ê°€ ë°ì´í„°ë¥¼ ì†¡ì‹ í•˜ê¸°ì— ì¶©ë¶„í•  ë•Œë§Œ ì†¡ì‹ í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

- `socket.bufferedAmout` í”„ë¡œí¼í‹°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ì— ìŒ“ì¸ ë°”ì´íŠ¸ ìˆ˜ í™•ì¸ ê°€ëŠ¥

```
// 100msë§ˆë‹¤ ì†Œì¼“ì— ìŒ“ì—¬ìˆëŠ” ë°”ì´íŠ¸ê°€ ì—†ëŠ” ê²½ìš° ë°ì´í„° ì „ì†¡
setInterval(()=>{
	if(socket.bufferedAmount == 0){
		socket.send(moreData());
	}
}, 100);
```

## 1-5 ì»¤ë„¥ì…˜ ë‹«ê¸°

- ì—°ê²° ì£¼ì²´(ì„œë²„, ë¸Œë¼ìš°ì €) ì¤‘ í•œìª½ì—ì„œ ì»¤ë„¥ì…˜ ë‹«ê¸°ë¥¼ ì›í•  ê²½ìš° `close()` ë©”ì„œë“œ ì‚¬ìš©

```
// ë‹«ê¸° ìš”ì²­ ì£¼ì²´
socket.close([code], [reason])

// ë‹¤ë¥¸ ì£¼ì²´
socket.onclose = (e) => {
	e.code = code
	e.reason = reason
}
```

> - `code` : ì»¤ë„¥ì…˜ ì¢…ë£Œì‹œ ì‚¬ìš©í•˜ëŠ” íŠ¹ìˆ˜ì½”ë“œ(ì˜µì…˜)
> - `reason` : ì»¤ë„¥ì…˜ ì¢…ë£Œ ì‚¬ìœ  ë¬¸ìì—´(ì˜µì…˜)

- [ì½”ë“œ ëª©ë¡](https://datatracker.ietf.org/doc/html/rfc6455#section-7.4.1)
  - `1000` : ì •ìƒ ì¢…ë£Œ(ê¸°ë³¸ ê°’)
    - `1000` ë³´ë‹¤ ì‘ì€ ê°’ì€ ì˜ˆì•½ ê°’ì´ë¼ì„œ ì„¤ì •ì‹œ ì—ëŸ¬ ë°œìƒ
  - `1006` : ì»¤ë„¥ì…˜ì´ ìœ ì‹¤ëœ ê²½ìš°(no close frame)
  - `1001` : ì—°ê²° ì£¼ì²´ ì¤‘ í•œìª½ì´ ë– ë‚¨(ì„œë²„ ì…§ ë‹¤ìš´, ë¸Œë¼ìš°ì € í˜ì´ì§€ ì¢…ë£Œ)
  - `1009` : ë©”ì‹œì§€ê°€ ë„ˆë¬´ ì»¤ì„œ ì²˜ë¦¬ ë¶ˆê°€
  - `1011` : ì„œë²„ ì¸¡ ë¹„ì •ìƒì ì¸ ì—ëŸ¬ ë°œìƒ

## 1-6 ì»¤ë„¥ì…˜ ìƒíƒœ

- `socket.readyState` í”„ë¡œí¼í‹°ì˜ ê°’ì„ í™•ì¸í•˜ë©´ ì»¤ë„¥ì…˜ ìƒíƒœ í™•ì¸
  - 0 : CONNECTING
  - 1 : OPEN
  - 2 : CLOSING
  - 3 : CLOSED

## 1-7 ì±„íŒ… ì•± ë§Œë“¤ê¸°

- ì›¹ì†Œì¼“ APIì™€ Node.jsì˜ ì›¹ì†Œì¼“ ëª¨ë“ˆì„ ì´ìš©í•œ ì±„íŒ… ì•±
- ì¬ì—°ê²°, ì¸ì¦ ë“± ê³ ê¸‰ ë§¤ì»¤ë‹ˆì¦˜ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŒ

```
// ğŸ“ index.html
// ë©”ì‹œì§€ í¼
<form name="publish">
	<input type="text" name="message">
	<input type="submit" value="ì „ì†¡">
</form>

// ë©”ì‹œì§€ ë°›ì„ ìš”ì†Œ
<div id="messages"></div>
```

```
// ğŸ“ Browser.js
<script>
	// ì»¤ë„¥ì…˜
	let socket = new WebSocket("wss://javascript.info/article/websocket/chat/ws");

	// ë©”ì‹œì§€ ì „ì†¡
	document.forms.publish.onsubmt = function() {
		let outgoingMessage = this.message.value;

		socket.send(outgoingMessage);
		return false;
	};

	// ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì¶œë ¥
	socket.onmessage = function(event) {
		// ë©”ì‹œì§€ ë°ì´í„°
		let message = event.data;

		let messageElem = document.createElement('div');
		messageElem.textContent = message;
		document.getElementById('messages').prepend(messageElem);
	}
</script>
```

```
// ğŸ“ Node.js
<script>
	const ws = new require('ws');
	const wss = new ws.Server({noServer : true});

	const clients = new Set();

	http.createServer((req, res) => {
		wss.handleUpgrade(req, req.socket, Buffer.alloc(0), onSocketConnect);
	});

	function onSocketConnect(ws){
		clients.add(ws);

		ws.on('message', function(message){
			// ìµœëŒ€ ë©”ì‹œì§€ ê¸¸ì´ëŠ” 50
			message = message.slice(0,50);
		})

		for(let client of clients){
			client.add(message);
		}
	};

	ws.on('close',function(){
		clients.delete(ws);
	})
</script>
```

---
