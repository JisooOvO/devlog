# 1. Polling

- ê°„ë‹¨íˆ êµ¬í˜„ê°€ëŠ¥í•œ ì„œë²„ í†µì‹  ë°©ì‹
- ì›¹ì†Œì¼“ì´ë‚˜ Server-sent event ê°™ì€ í”„ë¡œí† ì½œ ì—†ì´ ì„œë²„ì™€ ì§€ì†ì  ì»¤ë„¥ì…˜ ìœ ì§€ ê°€ëŠ¥

## 1-1 Regular Polling

- ì‘ë‹µì‹œ ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ ì˜¨ë¼ì¸ì´ë¼ëŠ” ì •ë³´ë¥¼ ë°›ìŒ ì´í›„ ì„œë²„ëŠ” ê·¸ ë•Œê¹Œì§€ ë°›ì•˜ë˜ ë©”ì‹œì§€ íŒ¨í‚·ì„ ì „ì†¡

- ë‹¨ì 
  - ë©”ì‹œì§€ëŠ” ìš”ì²­ ì‚¬ì´ì— ìµœëŒ€ 10ì´ˆì˜ ì§€ì—°ì„ ë‘ê³  ì „ë‹¬
  - ë©”ì‹œì§€ê°€ ì—†ì–´ë„ ì„œë²„ëŠ” 10ì´ˆë§ˆë‹¤ ìš”ì²­ì„ ë°›ìŒ

## 1-2 Long Polling

- ì§€ì—°ì—†ì´ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•˜ëŠ” ë°©ì‹

- ìš”ì²­ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ë©´

  > ì„œë²„ëŠ” ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œê¹Œì§€ ì—°ê²°ì„ ëŠì§€ ì•ŠìŒ

  > ë©”ì‹œì§€ê°€ ë„ì°©í•˜ë©´ ì„œë²„ëŠ” ë©”ì‹œì§€ì— ì‘ë‹µ

  > ë¸Œë¼ìš°ì €ëŠ” ì¦‰ì‹œ ìƒˆ ìš”ì²­ì„ ë³´ëƒ„

## 1-3 ë°ëª¨ ì±„íŒ… í”„ë¡œê·¸ë¨

```
// ğŸ“ index.html
<!DOCTYPE html>
<script src="browser.js"></script>

All visitors of this page will see messages of each other.

<form name="publish">
	<input type="text" name="message" />
	<input type="submit" value="Send" />
</form>

<div id="subscribe">
</div>

<script>
new PublishForm(document.forms.publish, 'publish');

// random url parameter to avoid any caching issues
new SubscribePane(document.getElementById('subscribe'), 'subscribe?random=' + Math.random());
</script>

// ğŸ“ browser.js
function PublishForm(form, url) {
	function sendMessage(message) {
Â  		fetch(url, {
			method: 'POST',
			body: message
		});
	}

	form.onsubmit = function() {
		let message = form.message.value;
		if (message) {
			form.message.value = '';
			sendMessage(message);
		}
		return false;
	};
}

function SubscribePane(elem, url) {
	function showMessage(message) {
		let messageElem = document.createElement('div');
		messageElem.append(message);
		elem.append(messageElem);
	}

	async function subscribe() {
		let response = await fetch(url);
		if (response.status == 502) {
			// reconnect
			await subscribe();
		} else if (response.status != 200) {
			// Show Error
			showMessage(response.statusText);

			// Reconnect in one second
			await new Promise(resolve => setTimeout(resolve, 1000));
			await subscribe();
		} else {
			// Got message
			let message = await response.text();
			showMessage(message);
			await subscribe();
		}
	}
Â 
	subscribe();
}

// ğŸ“ server.js
let http = require('http');
let url = require('url');
let querystring = require('querystring');
let static = require('node-static');
let fileServer = new static.Server('.');
let subscribers = Object.create(null);

function onSubscribe(req, res) {
	let id = Math.random();

	res.setHeader('Content-Type', 'text/plain;charset=utf-8');
	res.setHeader("Cache-Control", "no-cache, must-revalidate);

	subscribers[id] = res;

	req.on('close', function() {
		delete subscribers[id];
	});
}

function publish(message) {
	for (let id in subscribers) {
		let res = subscribers[id];
		res.end(message);
	}
	subscribers = Object.create(null);
}

function accept(req, res) {
	let urlParsed = url.parse(req.url, true);
Â 
	// new client wants messages
	if (urlParsed.pathname == '/subscribe') {
		onSubscribe(req, res);
		return;
	}

	// sending a message
	if (urlParsed.pathname == '/publish' && req.method == 'POST') {
		// accept POST
		req.setEncoding('utf8');
		let message = '';
		req.on('data', function(chunk) {
			message += chunk;
		}).on('end', function() {
	Â  		publish(message); // publish it to everyone
	Â  	res.end("ok");
		});
		return;
	}

	// the rest is static
	fileServer.serve(req, res);
}

function close() {
	for (let id in subscribers) {
		let res = subscribers[id];
Â 		res.end();
	}
}

// -----------------------------------
if (!module.parent) {
	http.createServer(accept).listen(8080);
	console.log('Server running on port 8080');
} else {
	exports.accept = accept;
	if (process.send) {
		process.on('message', (msg) => {
			if (msg === 'shutdown') {
				close();
			}
		});
	}

	process.on('SIGINT', close);

}
```

---
