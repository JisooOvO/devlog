# 1. Eloquent ORM

- ORM(Object-Relational Mapping)은 객체와 관계형 데이터베이스간의 매핑을 제공하는 기술
- 라라벨은 Eloquent ORM을 제공하여 테이블과 상호작용하기 위한 모델을 가짐

## 1-1 모델 생성

- `php artisan make:model 모델명` 아티즌 명령어로 새 모델 생성 가능
  - `--migration` : 데이터베이스 마이그레이션 생성
  - `--factory` : 팩토리 생성
  - `--seed` : 시드 생성
  - `--controller` : 컨트롤러 생성
  - `--resource`
  - `--request`
  - `--policy`
  - `-mfsc` : 마이그레이션, 팩토리, 시더, 컨트롤러
  - `--all`
  - `--pivot`

## 1-2 모델 컨벤션

- `app\Models` 디렉토리에 모델 생성
- ` Illuminate\Database\Eloquent\Model` 클래스를 상속

### 테이블 이름

- 모델에 해당하는 데이터베이스 테이블 이름은 snake case의 복수형이 됨

  - `Flight` 모델은 `flights` 테이블에 레코드 저장
  - `AirTrafficController` 모델은 `air_traffic_controllers` 테이블에 레코드를 저장

- `$table` 프로퍼티를 정의하여 테이블 이름을 수동으로 지정 가능

```
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Flight extends Model
{
    /**
     * The table associated with the model.
     *
     * @var string
     */
    protected $table = 'my_flights';
}
```

### 기본 키

- `$id` 라는 기본 키 컬럼이 있다고 가정
- 기본 키는 증가하는 정수 값으로 설정

> - 증가하지 않는 키를 사용시 `$incrementing` 프로퍼티를 `false`로 설정
> - 기본 키가 정수가 아닌 경우 `$keyType` 프로퍼티를 `string`으로 설정
> - `$primaryKey` 프로퍼티를 정의하여 다른 컬럼을 기본키로 사용 가능

```
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Flight extends Model
{
    /**
     * The primary key associated with the table.
     *
     * @var string
     */
    protected $primaryKey = 'flight_id';

    /**
     * Indicates if the model's ID is auto-incrementing.
     *
     * @var bool
     */
    public $incrementing = false;

    /**
     * The data type of the auto-incrementing ID.
     *
     * @var string
     */
    protected $keyType = 'string';
}
```

### composite key

- Eloquent는 결합 기본 키를 지원하지 않음

### UUID, ULID 키

- UUID(Universally Unique Identifier) : 범용 고유 식별자를 나타내는 36글자 길이의 문자열
  - 마이그레이션시 `uuid()`로 생성한 컬럼을 키로 사용 가능

```
use Illuminate\Database\Eloquent\Concerns\HasUuids;
use Illuminate\Database\Eloquent\Model;

class Article extends Model
{
    // 순서가 있는 UUID 생성
    use HasUuids;

    // ...
}

$article = Article::create(['title' => 'Traveling to Europe']);

// "8f8e8478-9035-4d23-b9a7-62f4d2612ce5"
$article->id;
```

- 모델의 `newUniqueID` 메서드를 정의하여 새로운 UUID 생성 프로세스 설정 가능
  > 또한 `uniqueIds` 메서드를 정의하여 UUID를 받을 컬럼 지정 가능

```
use Ramsey\Uuid\Uuid;

/**
 * Generate a new UUID for the model.
 *
 * @return string
 */
public function newUniqueId()
{
    return (string) Uuid::uuid4();
}

/**
 * Get the columns that should receive a unique identifier.
 *
 * @return array
 */
public function uniqueIds()
{
    return ['id', 'discount_code'];
}
```

- UUID 대신 26 글자 길이의 ULID 사용 가능

```
use Illuminate\Database\Eloquent\Concerns\HasUlids;
use Illuminate\Database\Eloquent\Model;

class Article extends Model
{
    use HasUlids;

    // ...
}

$article = Article::create(['title' => 'Traveling to Asia']);

$article->id; // "01gd4d3tgrrfqeda94gdbtdk5c"
```

### 타임스탬프

- 기본적으로 테이블 생성시 `created_at`, `updated_at` 컬럼이 자동 생성

  - 모델 생성 및 업데이트시 해당 컬럼의 값을 자동으로 설정
  - `$timestamps` 프로퍼티 값을 `false`로 변경시 자동 설정 해제

- `$dateFormat` 프로퍼티는 모델의 타임스탬프 형식을 지정 가능

  - PHP의 `date()` 함수에 사용되는 형식 기반

- 컬럼의 이름을 변경시 `CREATED_AT`, `UPDATED_AT` 상수를 정의

```
namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Flight extends Model
{
    const CREATED_AT = 'creation_date';
    const UPDATED_AT = 'updated_date';

    /**
     * Indicates if the model should be timestamped.
     *
     * @var bool
     */
    public $timestamps = false;

    /**
     * The storage format of the model's date columns.
     *
     * @var string
     */
    protected $dateFormat = 'U';

}
```

- `updated_at` 타임스탬프가 수정되지 않기를 원할 경우 `withoutTimestamps` 메서드 호출하여 작업

```
Model::withoutTimestamps(fn () => $post->increment(['reads']));
```

### 데이터베이스 연결

- 기본적으로 환경 파일에 설정된 데이터베이스를 연결하여 사용
- 특정 모델과 상호작용시 `$connection` 프로퍼티를 정의하여 다른 데이터베이스 사용 가능

```
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Flight extends Model
{
    /**
     * The database connection that should be used by the model.
     *
     * @var string
     */
    protected $connection = 'sqlite';
}
```

### 프로퍼티 기본 값 정의

- `$attributes` 프로퍼티 배열에 기본 값 정의 가능

```
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Flight extends Model
{
    /**
     * The model's default values for attributes.
     *
     * @var array
     */
    protected $attributes = [
        'options' => '[]',
        'delayed' => false,
    ];
}
```

### 엄격함 설정

> - `AppServiceProvider`의 `boot` 메서드에서 실행

- `preventLazyLoading()` : 레이지 로딩 금지 여부를 설정
- `preventSilentlyDiscardingAttributes` : `fillable` 배열에 없는 프로퍼티에 값 설정시 예외 처리
- `preventAccessingMissingAttributes` : 존재하지 않는 프로퍼티에 접근시 예외 처리
- `shouldBeStrict` : 앞의 3가지 메서드 모두 활성화

```
use Illuminate\Database\Eloquent\Model;

/**
 * Bootstrap any application services.
 *
 * @return void
 */
public function boot()
{
    Model::preventLazyLoading(! $this->app->isProduction());
}

```

## 1-3 모델 조회 방법

### 모든 레코드 검색

- `all()` : 모델 테이블에서 모든 레코드 검색

```
use App\Models\Flight;

foreach (Flight::all() as $flight) {
    echo $flight->name;
}
```

### Eloquent 모델은 쿼리 빌더

- 조건에 맞는 모델을 `get()` 메서드를 호출하여 검색 가능

```
$flights = Flight::where('active', 1)
               ->orderBy('name')
               ->take(10)
               ->get();
```

### 모델 리프레쉬

- `fresh()` : 데이터베이스에서 모델 다시 검색, 기존 인스턴스는 영향 없음

- `refresh()` : 데이터베이스의 최신 데이터로 모델 갱신

```
$flight = Flight::where('number', 'FR 900')->first();

$flight->number = 'FR 456';

$flight->refresh();

// "FR 900"
$flight->number;
```

### 컬렉션

- Eloquent 메서드는 `Illuminate\Database\Eloquent\Collection`인스턴스를 반환
- 컬렉션은 배열처럼 반복 가능한 래퍼 제공

- `all()` : 주어진 배열을 컬렉션으로 반환
- `avg()` : 키의 평균 값 반환
- `chunk(size)` : 컬렉션 배열을 size 만큼 분할
- `collect()` : 새 컬렉션 인스턴스 반환
- `contains(callback)` : 콜백 함수에 해당하는 아이템의 포함 여부
- `count()` : 컬렉션 배열 길이
- `dump()` : 컬렉션 내용 출력
- `each(callback)` : 콜백 함수에 아이템 하나씩 전달, `false` 반환시 중단
- `every(callback)` : 모든 요소가 콜백 함수 조건을 충족하는지 확인
- `except(array)` : 지정된 키를 제외한 모든 아이템 반환
- `filter(callback)` : 콜백 함수 조건에 해당하는 항목만 반환
- `first(callback)` : 조건에 해당하는 첫 번째 요소 반환, 없으면 `null`
- `firstOrFail()` : 조건에 해당하는 첫 번째 요소 반환, 없으면 ItemNotFoundException
- `firstWhere(conditon)` : 조건에 해당하는 첫 번째 요소 반환
- `forPage(pageNumber, itemNumber)` : 페이징 기능
- `get(key, defaultvalue)` : 키에 해당하는 아이템 반환, 없으면 `null` 또는 기본 값
- `has(keys)` : 키가 존재하는지 여부
- `implode(key, glue)` : 키에 해당하는 아이템을 합침, `glue`는 구분자
- `isEmpty()` : 컬렉션이 비어있는지 여부
- `join()` : 컬렉션의 값을 문자열로 변환
- `last()` : 컬렉션의 마지막 값 반환
- `macro(callback)` : 컬렉션에 메서드 추가
- `make()` : 새로운 컬렉션 인스턴스 생성
- `map(callback)` : 컬렉션 전체를 반복하여 콜백 함수에 전달하여 새로운 컬렉션 반환
- `sort()` : 컬렉션 정렬
- `toJson()` : 컬렉션을 JSON 변환
- `unique()` : 유니크한 아이템 반환
- `where(key,value)` : 키/값에 해당하는 컬렉션 필터링

### 지연 컬렉션

- 데이터베이스에서 받은 결과 집합을 필요한 시점까지 로드하지 않는 컬렉션

- `cursor()` 메서드를 사용하면 지연 컬렉션을 반환
  - 한번의 하나의 모델만 메모리에 할당하여 메모리 소비를 줄임

```
$users = User::cursor();
foreach ($users as $user) {
    // ...
}
```

- `lazy()` 메서드를 사용하면 지연 컬렉션을 생성 가능
  - 컬렉션 배열을 `chunk` 분할하여 쿼리 실행

```
use App\Models\Flight;

foreach (Flight::lazy() as $flight) {
    //
}
```

### 서브 쿼리

- 쿼리 빌더의 `select, addSelect` 메서드의 서브 쿼리 기능을 사용 가능

```
use App\Models\Destination;
use App\Models\Flight;

return Destination::addSelect(['last_flight' => Flight::select('name')
    ->whereColumn('destination_id', 'destinations.id')
    ->orderByDesc('arrived_at')
    ->limit(1)
])->get();
```

## 1-4 단일 레코드 검색

- `find, first, firstWhere` 등 단일 레코드 검색 가능한 메서드를 제공

```
use App\Models\Flight;

// id가 1인 모델
$flight = Flight::find(1);

// 조건에 해당하는 첫 번째 모델
$flight = Flight::firstWhere('active', 1);

// 조건에 해당하는 모델이 없으면 콜백 실행
$flight = Flight::where('legs', '>', 3)->firstOr(function () {
    // ...
});
```

### 예외 던지기

- `findOrFail, firstOrFail` 메서드는 결과가 없으면 `ModelNotFoundException` 발생

```
$flight = Flight::findOrFail(1);

$flight = Flight::where('legs', '>', 3)->firstOrFail();
```

## 1-5 모델 검색 또는 생성

- `firstOrCreate, firstOrNew` 메서드는 일치하는 레코드가 없을 경우 새 모델 인스턴스를 생성
  - 아직 데이터베이스에 저장되지 않음
  - `save()` 메서드 호출시 데이터베이스에 저장됨

```
$flight = Flight::firstOrCreate([
    'name' => 'London to Paris'
]);

```

## 1-6 모델 집계

- `count, sum, max` 등 집계 메서드 지원

## 1-7 모델 추가 및 수정

### Create

- 새 모델 인스턴스를 생성하여 `save()` 메서드로 모델 추가 가능
- `created_at, updated_at` 컬럼은 자동으로 설정

```

class FlightController extends Controller
{
    /**
     * Store a new flight in the database.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {
        // Validate the request...

        $flight = new Flight;

        $flight->name = $request->name;

        $flight->save();
    }
}
```

- `create()` 메서드로 새 모델 저장 가능

```
use App\Models\Flight;

$flight = Flight::create([
    'name' => 'London to Paris',
]);
```

### Update

- 이미 존재하는 모델의 프로퍼티 변경시 `updated_at` 컬럼 자동 변경

```
use App\Models\Flight;

$flight = Flight::find(1);

$flight->name = 'Paris to London';

$flight->save();
```

- 조건에 일치하는 모든 모델에 일괄적 업데이트 가능

```
Flight::where('active', 1)
      ->where('destination', 'San Diego')
      ->update(['delayed' => 1]);
```

- `updateOrCreate` 메서드는 모델이 없을 경우 새 모델을 생성

```
$flight = Flight::updateOrCreate(
    ['departure' => 'Oakland', 'destination' => 'San Diego'],
    ['price' => 99, 'discounted' => 1]
);
```

## 1-8 속성 변경 검토

- `isDirty(key)` : 모델이 조회된 이후 프로퍼티가 변경되었는지 확인
- `isClean(key)` : 모델이 조회된 이후 프로퍼티가 변경되지 않았는지 확인
- `wasChanged(key)` : 모델이 마지막으로 저장되었을 때 프로퍼티 변경 여부
- `getOriginal()` : 모델의 원래 프로퍼티 반환

## 1-9 대량 할당
